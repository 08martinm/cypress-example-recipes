version: 2

defaults: &defaults
  parallelism: 1
  working_directory: ~/app
  docker:
    - image: cypress/browsers:chrome63
      environment:
        ## this enables colors + fixes failing unit tests
        TERM: xterm
        # avoid million NPM install messages
        npm_config_loglevel: warn
        # allow installing when the main user is root
        npm_config_unsafe_perm: true
  steps:
    - checkout
    - run:
        command: echo current folder $PWD
        working_directory: "examples/$CIRCLE_JOB"
    - restore_cache:
        key: root-deps
    - run: npm install
    - run: npm prune
    - save_cache:
        key: root-deps-{{ checksum "package.json" }}
        paths:
          - node_modules
    - run:
        command: npm run start
        name: start the server
        background: true
        working_directory: examples/$CIRCLE_JOB
    - run:
        command: npm run cypress:run
        name: Cypress tests
        working_directory: examples/$CIRCLE_JOB
    - store_artifacts:
        path: $CIRCLE_JOB/cypress/screenshots
    - store_artifacts:
        path: $CIRCLE_JOB/cypress/videos

jobs:
  # define a new job with defailts for each "examples/*" subfolder
  blogs__codepen-demo:
    <<: *defaults
  blogs__direct-control-angular:
    <<: *defaults

workflows:
  version: 2
  # when adding new example subfolder with a recipe
  # add its name here to "create" CircleCI job
  all-recipes:
    jobs:
      - blogs__codepen-demo
      - blogs__direct-control-angular
